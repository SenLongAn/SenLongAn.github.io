---
title: Vulkan复习(验证层、设备、队列、表面、交换链、图像)
date: 2025-10-19 12:00:00 +0800
categories: [Vulkan]
tags: []     # TAG names should always be lowercase
math: true
---

# 验证层

* 默认情况下API中的错误检查非常有限，开启验证层将包含很多检查
  * 函数实参是否正确
  * 对象是否存在资源泄漏
  * 检查线程安全性
  * 每个函数调用和参数记录到标准输出
  * 性能分析
  * 可以在开发时使用，发布时禁用
* 流程
  * 初始化：
    * 检查支持：vkEnumerateInstanceLayerProperties枚举VkInstance的层属性，遍历层属性检查是否有VK_LAYER_KHRONOS_validation，如果有则表示可以支持验证层
    * 添加扩展：先通过glfwGetRequiredInstanceExtensions返回GLFW创建窗口所需的Vulkan扩展列表，设置给const char** glfwExtensions指向首元素的指针，在c++中我们使用扩展都是std::vector<const char*> 的形式，因此用glfwExtensions范围初始化它，再添加VK_EXT_DEBUG_UTILS_EXTENSION_NAME验证层扩展
    * 设置VkInstanceCreateInfo：
      * 扩展已在上一步加入，还需要设置enabledLayerCount层的数量，ppEnabledLayerNames层名字，
      * 创建VkDebugUtilsMessengerCreateInfoEXT调试信息结构体，并设置为pNext作为扩展
        * 消息级别（详细诊断信息，INFO一般信息，警告信息，错误信息），
        * 消息类型（GENERA一般消息，VALIDATION验证层，PERFORMANCE性能相关）
        * 它们值都是位掩码通过位|或进行组合（比如0b0001 + 0b0010 + 0b0100）
        * 回调函数（形参为PFN函数指针，接受函数的绑定），发送std::cerr错误日志
    * 设置调试消息：
      * 再次创建VkDebugUtilsMessengerCreateInfoEXT结构体
      * 通过vkGetInstanceProcAddr（对于全局函数可以直接使用，对于实例/设备级函数需要获取），获取vkCreateDebugUtilsMessengerEXT创建调试信息 函数地址，转换为PFN_vkCreateDebugUtilsMessengerEXT函数指针，并调用函数
  * 清理：vkDestroyDebugUtilsMessengerEXT销毁验证层扩展

# VkPhysicalDevice、VkQueueFamily

* VkPhysicalDevice物理设备：通过VkInstance查询属性（VRAM显存大小，设备支持哪些功能），选择一个/多个物理设备（优先推荐专用显卡）
* VQueueFamily队列家族：分为3类：图形、计算、内存传输
* 流程
  * 初始化：
    * vkEnumeratePhysicalDevices枚举物理设备，遍历检查每个设备，vkGetPhysicalDeviceQueueFamilyProperties获取物理设备队列家族，遍历队列家族，检查是否有VK_QUEUE_GRAPHICS_BIT标志，如果有退出循环，返回这个设备

# VkDevice、VkQueue

* VkDevice逻辑设备：使用什么 VkPhysicalDeviceFeatures 物理设备特性
* VkPhysicalDeviceFeatures：物理设备特性（多视口，64位浮点数）
* VkQueue：VQueueFamily中分配VkQueue队列，命令（绘制，内存操作）提交到队列异步执行，绘制命令的执行需要等待显示器读取完成（保证垂直同步）
* 流程
  * 初始化：
    * 再次获取VkQueueFamily索引，创建VkDeviceQueueCreateInfo设备队列，包含队列家族索引，队列数量，队列属性
    * 创建VkDeviceCreateInfo，包含VkDeviceQueueCreateInfo引用和数量，设备特性，扩展数量，验证层数量和名字
    * vkCreateDevice创建逻辑设备
    * vkGetDeviceQueue获取设备的VkQueue
  * 清理：vkDestroyDevice销毁逻辑设备

# VkSurfaceKHR

* VkSurfaceKHR窗口表面：窗口通常会使用像GLFW库创建，由于vulkan是跨平台的，所以需要有一个抽象层即表面，来与不同操作系统的窗口交互
* 流程
  * 初始化
    * 在创建VkPhysicalDevice前，glfwCreateWindowSurface调用glfw函数，创建VkSurfaceKHR
    * VkPhysicalDevice：如果一个设备的VkQueueFamily既包含VK_QUEUE_GRAPHICS_BIT又vkGetPhysicalDeviceSurfaceSupportKHR可以支持VkSurfaceKHR，则选择它
    * VkDevice：为每个VkQueueFamily，创建VkDeviceQueueCreateInfo设备队列，vkGetDeviceQueue要获取两次的VkQueue
  * 清理：vkDestroySurfaceKHR销毁窗口表面

# VkSwapchainKHR、VkImage

* VkSwapchainKHR交换链：一组渲染目标，确保不会发生图像撕裂（双缓冲/三缓冲 + 垂直同步）
* 流程
  * 初始化：
    * VkPhysicalDevice：
      * vkEnumerateDeviceExtensionProperties枚举VkPhysicalDevice扩展，遍历所有扩展，如果有VK_KHR_SWAPCHAIN_EXTENSION_NAME则表示此VkPhysicalDevice支持VkSwapchainKHR
      * vkGetPhysicalDeviceSurfaceCapabilitiesKHR获取VkPhysicalDeviced支持的VkSurfaceKHR的功能VkSurfaceCapabilitiesKHR，vkGetPhysicalDeviceSurfaceFormatsKHR获取VkPhysicalDeviced支持的VkSurfaceKHR的格式VkSurfaceFormatKHR，vkGetPhysicalDeviceSurfacePresentModesKHR获取VkPhysicalDeviced支持的VkSurfaceKHR的请求模式VkPresentModeKHR
      * 如果某物理设备，对之前的VkQueueFamily支持，支持VkSwapchainKHR，VkSurfaceFormatKHR和VkPresentModeKHR都不为空，则选择此物理设备
    * VkDevice:添加扩展VK_KHR_SWAPCHAIN_EXTENSION_NAME名字和数量
    * VkSwapchainKHR
      * 再次获取VkPhysicalDeviced对VkSwapchainKHR的支持
      * 遍历VkSurfaceFormatKHR，如果格式为VK_FORMAT_B8G8R8A8_SRGB / VK_COLOR_SPACE_SRGB_NONLINEAR_KHR，则选择它，否则选择首个元素
      * 遍历VkPresentModeKHR，如果有VK_PRESENT_MODE_MAILBOX_KHR选择它，否则为VK_PRESENT_MODE_FIFO_KHR
      * 如果VkSurfaceCapabilitiesKHR当前的宽度超过uint32_t最大值，则glfwGetFramebufferSize获取帧缓冲的大小，将帧缓冲的宽高限制到VkSurfaceCapabilitiesKHR可以支持的宽高，并作为VkSurfaceCapabilitiesKHR当前的宽高
      * VkSurfaceCapabilitiesKHR，如果minImageCount==maxImageCount则返回maxImageCount
      * VkSwapchainCreateInfoKHR，包含最小图像数量，图像格式，颜色空间，图像大小，图像数组层，图像用法（颜色附件），图像共享模式（并发，独立），VkQueueFamily数量和索引，传输，透明度，请求模式，是否裁剪，交换链，vkCreateSwapchainKHR创建交换链
      * vkGetSwapchainImagesKHR获取交换链图像
  * 清理：vkDestroySwapchainKHR销毁交换链

# VkImageView

* VkImageView图像视图：对VkSwapchainKHR的图像包装为VkImageView
* 流程
  * 初始化：创建VkImageViewCreateInfo，包含图像（VkSwapchainKHR中创建的），视图的类型（2D，3D……），图像格式（VkSwapchainKHR图像格式），颜色组件（rgba），图像子资源（位掩码，mipmap 级别,mipmap 级别数量,数组层,数组层数量），vkCreateImageView创建
  * 清理：vkDestroyImageView销毁图像数组
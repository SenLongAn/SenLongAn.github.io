---
title: 101复习(3`光栅化，傅里叶变换，深度测试，着色)
date: 2025-09-03 12:00:00 +0800
categories: [Games101]
tags: []     # TAG names should always be lowercase
math: true
---

# 光栅化

* 通过MVP变换，得知了世界空间中物体点映射到屏幕空间的什么位置
* 光栅化将图元（点/线/三角形……）转换为片元（像素）
* 采样法：遍历屏幕内每个像素中心的采样点，进行覆盖性测试，利用叉乘判断是否在图元内部
* 优化：根据顶点确定包围盒范围，仅遍历包围盒范围内的采样点
* Aliasing走样问题：锯齿，摩尔纹（moire Patterns）（水波纹），车轮效应（分不清顺逆时帧旋转）……
* 抗锯齿：SSAA,MSAA,FXAA,TAA……详见其他章节

# 傅里叶级数变换

* 周期函数
  * 函数：y = f(x)，和编程语言的函数很相似，都有输入输出函数名函数体
  * 周期函数：形如正弦、余弦
  * 周期：是从一个最高点到下一个最高点
  * 振幅：从中线（x）到最高点/最低点的高度（y）,也是从最高点到最低点的距离除以2
  * 相移: 函数水平向右移动多远
  * 垂直位移：函数垂直向上移动多远
  * 频率：1/周期
  * y = A sin(Bx + C) + D
    * 振幅是A
    * 周期是2π/B
    * 相移是−C/B
    * 垂直移位是D
* 傅里叶级数变换
  * ![1](/assets/img/blog/Games101/傅里叶级数展开.png)
  * 傅里叶级数展开：微积分中的函数展开方法之一，任何一个周期函数都可以写成一系列的正弦余弦函数组合 + 常数项，比如一个凹凸的函数可以近似为cos函数向上移动后
  * 傅里叶级数变换：把一个函数经过复杂变换为另一函数，还可以逆变换为原函数
  * 采样和频率：频率越高的函数需要越多的采样点表示

# 深度测试

* 3D-遮挡关系
* 深度值计算：发生在光栅化阶段，如果像素通过覆盖性测试，根据图元3个顶点在NDC空间下的z值，和当前像素位置做插值
* 深度值存储：计算完成将存储在寄存器中，供之后适用
* 深度缓冲：通常分辨率和颜色缓冲一致，每个像素存储float深度值，限制到0——1之间，深度越近越接近0
* 提前深度测试（可选）：发生在fs之前，Early-Z深度测试依赖于上一次drawcall的late-z的结果，不会更新深度缓冲，将未通过深度测试对应的片段丢弃
  * 优势：让未通过深度测试的片段不必fs计算
* 默认深度测试（必须）：发生在fs之后（同样一个像素对应的所有颜色值也存储在寄存器中），根据比较规则和寄存器中的深度信息更新深度缓冲和颜色缓冲
* 注意：Early-Z不会更新深度缓冲，默认深度测试的存在是必须的
  * 开启Alpha测试
  * 假如有2个物体ab，a为完全透明，b不透明，且b在a后，预期结果为呈现b
  * 如果只存在late-z：
    * ab覆盖的片元都被fs计算，Alpha测试后a未通过丢弃，b通过，与预期结果相符
  * 如果只存在early-z并允许更新深度缓冲：
    * 丢弃b片元，保留a，fs：计算a片元颜色值，Alpha测试：丢弃a，结果ab都被丢弃，和预期不符
  * Early-Z不更新深度缓冲，late-Z更新深度缓冲
    * Early-Z：深度缓冲区初始为1.0，ab通过Early-Z，fs：计算a片元颜色值，Alpha测试：丢弃a，late-z：b通过，与预期结果相符
* 深度冲突
  * 由于深度缓冲的精度有限，可能会发生深度值相同的情况，此时会造成画面闪烁
  * 解决方法
    * 尽量不要物体靠太近
    * 使用更高精度的深度缓冲
    * 近平面设置远一些，近处精度高（在经过透视投影变换后，近处物体的深度值差异较大，远处物体的深度值差异较小）

# 着色
  
* 原理
  * 不同表现效果：光的不同作用方式
  * 作用方式：散射（反射（漫反射，镜面反射），折射）吸收，被吸收的颜色，微表面方向、自遮挡……
  * 颜色：未被吸收的物体颜色传入人眼，使得我们看到物体颜色
  * 反射：
    * 笼统角度：漫反射向周围四面八方反射，镜面集中在一个镜面波瓣的反射，通常物体越粗糙越接近于漫反射
    * 微观角度：物体越粗糙，微表面越不平整，光线反射方向偏差大，微表面越平整，光线总是趋近于同一方向反射
  * 高光：镜面反射由于光线反射的聚集性，亮度很高
  * 阴影：光的直线传播中被物体阻挡，从而照射不到的物体形成阴影
  * 夹角：光线方向和法线方向夹角越大，物体接收到的光能量就越小，颜色越暗
  * 各项异性材质：微表面存在一定的方向性
  * 能量守恒：光线传播越远每个角度的能量越小
* Blinn-Phong着色模型(近似计算场景颜色的算法模型)
  * 视线方向v，光线方向i，法线方向n，光源位置l，着色点位置o，物体颜色c，反光度s……其中inv为单位向量
  * 未被吸收/物体颜色：定义为变量
  * 不考虑折射，阴影，粗糙度……
  * 定义漫反射是均匀的
  * 漫反射：Ld = kd(I/r^2)max(0,i*n); 吸收 + 接收 + 反射，kd表示未被吸收的颜色，I为光线强度，r为光与点的距离，0限制到0——90°，不考虑从平面下方照射
  * 镜面反射：Ls = ks(I/r^2)max(0,n*h)^s, 吸收 + 接收 + 反射，ks表示未被吸收的颜色，指数反光度s越大cos曲线越陡峭，控制高光范围越小变换越剧烈
  * 半程向量h：
    * v+i的单位向量，vi两个方向的平分向量，原本比较v和r反射向量接近程度，现在比较n和h接近程度
    * 解决断层：当物体较粗糙，高光区域会很大，会看到很大的断层，因为vr超过了90度点乘为负数取0，通过转换到hn点乘，相当于从0——180°夹角范围约束到了0——90°范围，使得视线在平面上方任何角度观察，结果都>=0
    * nh夹角通常比vr夹角更小，表现为亮度更高，范围更广，可以通过增大指数来达到和冯氏光照一样的效果
  * 环境光：kaIa，颜色，强度假设对于所有位置都相同
* 着色频率
  * 按顶点，像素根据顶点的fs结果插值，开销更小，效果略次
  * 按像素，像素根据顶点的数据插值，用fs计算，开销更大，效果更好
  * 两种方式顶点数量越多，效果越好


---
title: OpenGL复习(MRT、泛光、延迟渲染)
date: 2025-06-25 12:00:00 +0800
categories: [OpenGL]
tags: []
math: true
---

## 多渲染目标(Multiple Render Targets)MRT

* 帧缓冲可以附加多个颜色纹理附件，从而在一次pass可以指定多个像素着色器输出多张纹理图片（即多个渲染目标）

## 泛光

* bloom让光源向四周发散出光晕，使得看起来更亮更真实
* 实现方式：
  * 对渲染的纹理提取超出一定亮度的片段，可以使用MRT技术
  * 对新的纹理模糊，可以使用高斯模糊
  * 两个纹理叠加，颜色相加再转换

## 延迟渲染deferred rendering（性能优化）

* earlyz可以极大减少不必要的fs计算，但由于渲染顺序问题仍有很多物体的覆盖片段需要光照计算，当场景有大量光源时，这种性能消耗将变的非常巨大，想象数千个光源每个都要对每次通过测试的物体的覆盖片段光照计算
* 使用两个处理阶段(Pass)
  * 几何处理阶段(Geometry Pass)，不做光照计算，获取对象的各种几何信息，存储在G缓冲(G-buffer)中
  * 光照处理阶段(Lighting Pass)，使用G-buffer的数据，渲染一个屏幕大小的方形，对每个片段光照计算
* 两个不同的pass为什么会使用到一样的深度缓冲信息
  * 理解有偏差，在Geometry Pass开启了深度测试，不断更新G-buffer数据，最终记录最顶层的片段数据，并不是使用同一个深度缓冲信息
* 原理：有了最顶层的片段数据，只需要仅对每个屏幕像素做一次光照计算即可
* G-buffer包含哪些数据
  * 所有光照相关的数据，每类数据以纹理形式存储
* G-buffer是怎样实现
  * 它实际上就是名为G-buffer的帧缓冲，使用MRT技术
* opengl的Geometry Pass的如何将数据输出到各自的颜色缓冲
  * 颜色纹理附件格式GL_COLOR_ATTACHMENT0,GL_COLOR_ATTACHMENT1^,与 fs中的输出layout (location = ……) 对应
* 延迟渲染缺陷
  * 消耗内存，因为要存储大量几何数据
  * 不支持不同的光照算法
  * 不支持颜色混合/半透明物体，颜色混合发生在fs中，正向渲染时每个像素执行多次光照计算，每次都可以和缓冲中的颜色混合计算，但Lighting Pass时仅有最顶层的片段数据，没有其他被丢弃片段的信息，无法混合（依赖于被遮挡片段信息，信息缺失）
  * 不支持抗锯齿，抗锯齿发生在fs后，首先没有4个sample存储，就算新建数组存储，颜色不知道是否应该拷贝给sample（不知道是否被图元覆盖），拷贝给谁（属于哪个图元），没有不同片段的颜色拷贝到不同的sample（只记录最顶层的片段数据），总之就是不能计算出预期颜色（信息缺失）
* 解决缺陷
  * 再延迟渲染后进行正向渲染
  * 要注意深度问题
    * 延迟渲染中深度信息在G-buffer的缓冲中，在Lighting Pass阶段虽然在默认缓冲中，但并没有更新深度缓冲，因此正向渲染全部会覆盖延迟渲染，
    * 解决方法，把gBuffer的深度信息写入到默认帧缓冲
  * 想办法存储几何数据
* 延迟渲染 vs 正向渲染
  * 延迟渲染不支持一些功能，
  * 在较小场景光源较少时，延迟渲染可能更慢，因为两次pass的消耗 > 对不必要光照计算的优化

## 光体积(Light Volumes)（性能优化）

* 虽然延迟渲染是一个很大的优化，但仍不能支持非常大量的光源
* 因为仍然需要为每一个光源对每一个片段做光照计算，这仍是非常庞大的
* 原理：计算光源的半径/体积，只对在光体积内的片段光照计算，可以省下来很可观的计算量
* 技术方案
  * 方法一
    * 求半径
      * 利用衰减方程，将黑暗0颜色带入公式获取半径，但由于永远不会==0，所以使用近似黑暗的5/256颜色值
      * 通过移项形成一元二次方程，可以通过求根公式解
    * 如何知道片段是否在光源的体积内部
      * 在fs中for每个光源，都if判断光到点的世界距离< lights[i].Radius
    * 不可行
      * GPU高度并行性质并不擅长优化循环和分支，GPU需要完全一样的shader从而获得高效率，这意味着它会执行if所有分支（也就是无论是否在光源中都会被光源计算）
  * 方法二
    * 几何信息存储到 G-Buffer 中
    * 正向渲染：依次遍历光源，为光渲染实际球体，半径依旧用衰减方程计算，仅对被光覆盖的片段渲染（利用G-Buffer），不同光源结果颜色混合
    * 要注意面剔除问题？？？

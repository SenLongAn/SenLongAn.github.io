---
title: Games202(4·第7章)
date: 2025-03-03 12:00:00 +0800
categories: [Games202]
tags: [实时渲染]     # TAG names should always be lowercase
math: true
---
# 第7章

#### PRT（Precomputed radiance transfer）预计算辐射传输

我们这次考虑了阴影可视项V，其中使用PRT方法

**PRT vs. 直接采样**

PRT的核心思想是预计算，利用基函数（例如SH，Wavelet、Zonal Harmonics、Spherical Gaussian、Piecewise Constant……）计算数据并存储起来，

优点：从而降低运行时的性能开销，适用于环境光等复杂光照效果

缺点：存储量大，仅适用于静态场景

直接采样通过随机/有偏采样（例如蒙特卡洛方法）计算数据

优点：支持动态场景

缺点：计算量大

**sh vs. Wavelet**

sh: 仅对低频友好,但由于旋转不变性，支持光源的旋转

Wavelet:支持全频，但是只有很少的系数是非零）（递归左上低频数据，其他3部分保留高频数据，不支持光源的旋转

**Diffuse部分2种分解方式：**

我们首先将rendering equation分为两部分,lighting光照 和 light transport光照传输

![1740961941876](/assets/img/blog/Games202/渲染方程_漫反射.png)

p项提前，L项用sh函数表示，li系数提取到积分外，light transport项作为系数，和Bi再次组成sh函数

![1740961957711](/assets/img/blog/Games202/渲染方程_漫反射2.png)

方程中的lighting和light transport，都用sh基函数表示，变成双重求和

**Specular部分2种分解方式：**

p项并非常量，不可以提取到积分外,且依赖于视角O

![1740961981775](/assets/img/blog/Games202/渲染方程_镜面反射.png)

L项用sh函数表示，li系数提取到积分外，light transport项作为系数（V，p(o), max）,和B（O）再次组成sh函数, 即T(o)

可以理解为light transport投影到Bi上

还可以用双重求和表示, 可以理解为Product Integral（乘积积分）指对两个函数的乘积在某个域上求积分: ∫(Ω) f(x)⋅g(x)dx, 即L(o) 和 T(o)

PRT Glossy比Diffuse 效率要差很多，将会产生巨大的存储

**Reflective Shadow Map(RSM)反射阴影贴图**

光线在场景bounce弹射多次形成Global Illumination (GI)全局光照，在实时渲染中,全局光照是比直接光照**多一次**bounce的间接光照.也就是经过2次物体bounce到达eye

在101 path tracing时讲了，tracing的物体可以被当作次级光源(Secondary Light Sourse)来照亮其他物体

如果想要计算点P的shading，需要知道哪些表面作为次级光源，对于的贡献值是多少

RSM中假设所有的反射物都是diffuse的，因此不论从camera哪个角度看结果都是一致的

![1740986475703](/assets/img/blog/Games202/光源采样.png)

要对p点shading，我们要从半球所有立体角采样，我们在101提到，这样的话很浪费很多的sample,因此应从光源处采样

如图所示，从半球所有立体角采样，转换为pq（光源到shading point）radiance的采样

一个次级光源q对p的贡献值：

![1740987283308](/assets/img/blog/Games202/p对q贡献值.png)

![1740987434876](/assets/img/blog/Games202/值.png)

其中因为次级光源是diffuse的，因此f项为常数（图2），Li（图2）和Da刚好会被抵消，即Ep

注意这里是2次非4次

**RSM的可视性**

常规思路是为每个次级光源按照pq方向算一次shadow map，但这个性能开销非常庞大（想象每个次级光源对场景中任何一个点p都生成一个SM），其他也没有什么好的方法，因此不考虑可视性了

**RSM 次级光源贡献**

![1740991604872](/assets/img/blog/Games202/RSM光源贡献.png)

如图所示，左上为光源，黄色范围为光照区域（可以用SM平面来表示，每个pixel为光源的一个方向，每个方向都是一个次级光源），x为着色点

对每个p点找到所有次级光源计算贡献，仍然是非常大的开销，为了加速这一过程, 我们认为SM的所有pixel不可能都有贡献，因此仅查找x在SM上临近范围（p红色平面范围内），差不多采样400个次级光源

且为了弥补越往外采样数越少可能会带来的问题，引入了权重，越近的权重越小，越远的权重越大

**RSM数据存储**

在每一个像素中都需要存储深度值，世界坐标，法线，反射光功率


**RSM vs. 光线追踪全局光照**

rsm：基于阴影贴图的近似方法，

优点：适合在光栅化方式中实时渲染，开销量低

缺点：精度较低，仅支持近似的间接光照

光线追踪：

优点：精确模拟

缺点：计算量大，实现复杂，离线渲染
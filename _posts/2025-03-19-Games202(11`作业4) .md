---
title: Games202(11`作业4)
date: 2025-03-19 12:00:00 +0800
categories: [Games202]
tags: [实时渲染]     # TAG names should always be lowercase
math: true
---
# 作业4

**前言**

微表面模型的BRDF(Microfacet BRDF)存在一个根本问题，就是只考虑了首次弹射出射的能量，忽略了首次未出射的能量，而这部分能量会参与到微平面间的多次弹射中，一部分会弹射到人眼，这就导致了材质的能量丢失，并且当材质的粗糙度越高时，能量的丢失会越严重

Kulla-Conty BRDF模型，引入一个微表面BRDF的补偿项fms，来补偿光线的多次弹射，使得材质的渲染结果可以近似保持能量守恒

框架分为两个工程：

* 在离线端(lut-gen文件夹中)包含4个文件，lut-Emu-MC、lut-Emu-IS、lut-Eavg-MC、lut-Eavg-IS，在这里预计算E(μ)和Eavg，它们是计算fms时需要的前置变量，后缀MC的文件为基础实现，后缀为IS文件的是提高部分实现
* 在实时端(homework4文件夹中)通过查询预计算数据构建BRDF的补偿项

初始场景：

![1742449318289](/assets/img/blog/Games202/初始场景.png)

## 实现预计算 E(μ)

首先计算首次弹射出射的未丢失总能量，在Emu_MC.cpp的IntegrateBRDF函数写

* 框架提供了squareToCosineHemisphere（）函数，随机采样1024个方向
* 根据eu的公式，每次需要计算BRDF项 * cos项 / pdf项，FGD/4.0 * NdotV * NdotL/pdf * NdotL（cos项）
* 其中abc3个变量是等量的，只是为了可读性

测试结果：

* 生成工程：执行test.sh命令脚本
  * 强制删除build 的目录及其内部的所有文件和子目录
  * 创建build目录
  * 进入build目录
  * 构建sln工程
  * 编译
  * 运行可执行文件（.exe）
  * 返回项目根目录
* 编译：在编译这一步没有正确执行，我们用vs去build它，生成了exe文件
* 运行：通过手动运行文件生成了图片于/build/debug/…….png

![1742527705093](/assets/img/blog/Games202/eu预计算.png)

## 实现预计算 Eavg



## 正确实现PBR材质



## 正确实现Kulla-Conty材质



## 提高：实现重要性采样的预计算方法

在预计算 E(μ)这个部分，我们生成的结果以粗糙度和角度作为两个维度,可以看到左边a较低时有很多噪声，

这是因为低粗糙度的微表面材质接近镜面反射材质，即微表面的半程向量h（wi和v）集中分布在几何法线n附近，而我们由采样入射光方向i计算出的微表面半程h分布并不会集中在几何法线n附近，

也就是说这与实际低粗糙度的微表面法线分布相差很大，因此积分值的方差就会很大，可以通过对微表面法线m进行重要性采样来改善这个一问题

## 提高： 在预计算 E(μ) 时，使用Split Sum完成预计算工作



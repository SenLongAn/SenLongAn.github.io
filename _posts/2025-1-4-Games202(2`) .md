---
title: Games202(2·第4章)
date: 2025-01-04 12:00:00 +0800
categories: [Games202]
tags: [实时渲染]     # TAG names should always be lowercase
math: true
---
# 第4章

首先来复习下opengl判断是否位于阴影过程的一些细节：

如何获取world pos 在shadowmap对应的坐标，首先通过lightmatrix矩阵变换到光空间（标准化设备坐标），然后手动的/w（视口变换） -> 映射到0--1之间，根据这个坐标从map采样，再对比它的z

##### 优化性能

如何优化pcf以及pcss的性能呢，在区域计算时，随机采样指定数目的像素，而不是区域内的所有像素，但是这样会导致噪声，

另一种方法不再计算区域内的每个像素（比如8*8=64），而是通过转为正太分布的pdf，估计概率，这就是vssm

##### vssm （variance soft shadow mapping）方差软阴影映射

vssm正是为了解决软阴影实现的性能问题，那么为了映射为正太分布，我们需要求出曲线的均值，和方差，然后求出pdf中满足一定区域的概率

**求均值：**
* mipmap：它只能在正方形内查询，并且它是不准的
* SAT（summed area tables）：可以在长方形查询，结果是准确的
  * sat算法是为了解决快速区域查询的，它的思想是前缀和表

![1736083266125](/assets/img/blog/Games202/2d区域查询.png)

  * 为了理解，我们首先看一维，比如我要快速获取原数组的和，可以通过新建一个前缀和数组（遍历n次，每次累加的值存储到新数组中），在区域查询时直接从新数组获取ab的索引，两者相减即可
    * 对于2维同样，不过ij的值需要：（K为区域的半径）
    * sum = P[i + K + 1][j + K + 1] - P[i - K][j + K + 1] - P[i + K + 1][j - K] + P[i - K][j - K]
    * 对于查询时需要：[i + K, j + K] - [i - K, j + K] - [i + K, j - K] + [i - K, j - K]

**求方差：**
我们利用了公式：x平方值的期望 - x期望值的平方 = 方差

因为shadowmap中存储的depth就是x，区域的均值就是期望，因此只需要在计算shadowmap时，额外生成一张shadow map，它保存的是depth^2即可
  
**求概率**

CDF : 累积分布函数,是pdf的积分 == 函数的面积

![1736083528679](/assets/img/blog/Games202/切比雪夫不等式.png)

但是也可以通过切比雪夫不等式 在知道 期望 和 方差 时候 近似求得x > t（必须在均值的右边）时的概率

# 正太分布

![1736083686852](/assets/img/blog/Games202/正太分布图像.png)

对于连续性随机变量X（样本到实数映射的函数），其中ab区间的概率 == ab区间的面积

正态分布又称高斯分布函数：通常会呈现钟形曲线，中间区域概率高，两侧的概率低，且不想左右偏移：
* 平均值 = 中位数 = 众数
* 沿中线对称
* 50% 的值小于平均值，50%的值大于平均值

正太分布由几个概念组成：

* 均值μ：决定了正态分布曲线的中心位置，也是分布的期望值
* 标准差σ：决定了正态分布曲线的形状，标准差越大，曲线越分散；标准差越小，曲线越集中
* 方差σ^2:方差是标准差的平方，表示数据离散程度的度量

